---
title: Exploring the Relationship Between Deprivation, Cardiovascular Health, and Antihypertensive Prescriptions in Scotland
author: "Brian Kim"
date: "2024-11-01"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warnings=FALSE)
```

## Introduction

Cardiovascular disesase (CVD) refers to group of conditions affecting the heart and blood vessels. CVD is the leading cause of death both globally and in Scotland [(British Heart Foundation, 2018)](https://www.bhf.org.uk/for-professionals/healthcare-professionals/data-and-statistics/the-cvd-challenge/the-cvd-challenge-in-scotland), emphasizing the need to better understand their risk factors and treatment trends. The causes of CVD are multifactorial, with various risk factors contributing to its development. Among these, hypertension (high blood pressure) is commonly recognized as one of the strongest and most prevalent risk factor for CVD, with strong evidence supporting its causal relationship [(Fuchs and Whelton, 2020)](https://pubmed.ncbi.nlm.nih.gov/31865786/).

To address this growing risk, this project aimed to explore whether there is a trend in antihypertensvie medication prescribing acrouss council ares in Scotland. Specifically, the study aimed to examine the relationship between prescribing patterns and key demogrpahic factors that influence this such as age and deprivation levels. Data was analyzed on the level of council area  in Scotland. Speficially my project focused on examining whehter trend exist in anitherpyensive medication prescring areas with higher proportion of adults or areas with higher "deprivation score" according to the 2020 Scottish Index of Multiple Deprivation (SIMD), were associated with increasing prescribing of antihypertensvie medications.

For this report, "elderly" population refers to individuals aged 65 and older in alignment with common health guidelines. All datasets  used in this project and their respective data dictionaries were sourced from Public Health Scotland Open Data, which can be accessed here:
https://www.opendata.nhs.scot/

The time scope of this report is limited to 2022, mainly because the most recent heart disease mortality data available was between January 1 to December 31, 2022. Additionally, the most recent GP demographic dataset for 2022 was from October, which is why the October 2022 prescription dataset was chosen for analysis.

```{r Loading Libraries}
#Loading required libraries
library(tidyverse)
library(janitor)
library(gt)
library(here)
```

## Refining Prescription Data
To start with, the 2022 October prescription dataset was loaded and cleansed. Given the large variety of antihypertensive drugs, the scope was narrowed down to just calcium channel blockers, including both the brand and generic names. Finally, dataset was refined to include only the columns of interest.

```{r}
#Loading 2022 october prescription data
prescriptions_data <- read_csv("/Users/Studnet Data/Year 4/data_science/B138584/data/oct2022per.csv") %>% 
  clean_names()

#Defining calcium channel blockers to filter in data
calcium_channel_blockers <- c("Norvasc", "Amlodipine", "Diltiazem", "Cardizem", "Tiazac", "Plendil", "Felodipine", "DynaCirc", "Isradipine", "Cardene", "Nicardipine", "Sular", "Nisoldipine",  "Verelan", "Covera HS", "Isoptin SR", "Verapamil", "Procardia XL", "Adalat CC", "Nifedipine") %>% 
  toupper() #Convert all names to uppercase 

#Filtering the Prescription data
filtered_prescriptions <- prescriptions_data %>% 
  filter(str_detect(bnf_item_description, paste(calcium_channel_blockers, collapse = "|"))) %>% 
  filter(hbt != "SB0806") %>% # Exclude ambulance prescriptions (hbt = SB0806)
  select(gp_practice, hbt, bnf_item_description, paid_quantity) #filtering only the columns we're interested in

```

## Merging GP Population Demographic Data
The dataset with GP population demographic was then loaded and processed to identify the number of elderly population. This was achieved by summing the population over 65 years old for each GP practice. The resulting dataset was then joined with the filtered prescription dataset based on GP codes.

```{r}
#Loading GP demographic data
gp_demographic_data <- read_csv("/Users/Studnet Data/Year 4/data_science/B138584/data/GPDemographic2022oct.csv") %>% 
  clean_names()

#Calculating number of elderly population per GP
filtered_gp <- gp_demographic_data %>% 
  mutate(over_65 = ages65to74 + ages75to84 + ages85plus) %>%   
  select(practice_code, hb, hscp, over_65) %>%  
  group_by(practice_code) %>% 
  summarise(over_65_total = sum(over_65, na.rm = TRUE)) 

#Joining GP demographic data to prescription data
prescriptions_age <- filtered_prescriptions %>% 
  left_join(filtered_gp, by = join_by(gp_practice == practice_code)) 
```

## Merging Healthboard and Council Area Data
Then Health Board (HB) names dataset was loaded to add the corresponding HB names to the prescription dataset. The HB Codes were renamed and selected to match the prescription dataset, and two dataset were joined.
```{r}
#Loading Health Board name data
healthboards_name <- read_csv(here("/Users/Studnet Data/Year 4/data_science/week_7_thurs/Healthboard.csv")) %>%
  clean_names() 

#Preparing HB name data for joining
filtered_hb_name <- healthboards_name %>% 
  rename(hbt = hb) %>% 
  select(hbt, hb_name)

#Joining HB names with prescription dataset by HB code
prescriptions_age_hb <- prescriptions_age %>% 
  left_join(filtered_hb_name, join_by(hbt))
```

Then, the council area (CA) information was added. the CA_HB dataset, which links council areas to health boards, was loaded and processed to ensure the correct mapping of council area names to their respective healthboards. the council area names were grouped and concatenated by their respective healthboard before being joined with the prescription dataset. This step was done because different council area share the same HB code therefore if join by HB code it will create many new data which was not present in the original dataset. So did it by grouping all councail area in the respective healthbaord.

```{r}
#Loading Council Area, Health Board data
ca_hb <- read_csv("/Users/Studnet Data/Year 4/data_science/B138584/data/CA:HB_CODES.csv") %>%
  clean_names()

#Refining CA data for joining
filtered_ca_hb <- ca_hb %>% 
  select(hb_name, ca_name, ca) %>% 
  group_by(hb_name) %>% 
  summarize(council_area = paste(unique(ca_name), collapse = ", ")) # Combine council area names for each 

# Joining Council Area data with the prescription data
prescriptions_age_hb_ca <- prescriptions_age_hb %>% 
  left_join(filtered_ca_hb, by = join_by(hb_name))
```

## Merging CVD Mortality Outcome data
Lastly,  mortality rate from CVD was added. Filtered out the death from 2022 and the cases of death in the age group 65+. Data was joined by health board regions, summing the total number of death for indivdiuals aged 65 and older in each health board council area regions. Some CA including Na h-Eileanan Siar, Orkney Islands, Shetland Islands reported 0 cases of cardiovasculra death so they were filtered out from the analysis as it probably is like an error or there was problem in data collection.
```{r}
#Loading CVD outcome data
heart_mortality_data <- read_csv("/Users/Studnet Data/Year 4/data_science/B138584/data/HeartDiseaseMortality.csv") %>% 
  clean_names()

#joining heart disease outcome by hb code
filtered_heart_data <- heart_mortality_data %>% 
  select(year, hbr, number_of_deaths, age_group) %>% 
  filter(age_group %in% c("75plus years", "65-74 years")) %>% #filtering for 
  filter(year == 2022) %>% 
  group_by(hbr) %>% 
  summarise(over_65_total_death = sum(number_of_deaths, na.rm = TRUE)) 
  
```

Next, the population of individuals aged 65 and older was calculated for each council area. This was done by grouping the GP-level demographic data by council area and summing the over-65 population (over_65_total) for each council area. These population metrics were then joined with the prescription dataset and the mortality dataset, ensuring a comprehensive view of prescriptions, demographics, and heart disease outcomes. 

```{r}
#Creating a column that has number of population for merged council area
total_over65_ca <- prescriptions_age_hb_ca %>% 
  select(council_area, gp_practice, over_65_total) %>% 
  distinct() %>% #remove duplicate
  group_by(council_area) %>% 
  summarise(over65_CA = sum(over_65_total, na.rm = TRUE))

#Final Joined Data
joined_data_final <- prescriptions_age_hb_ca %>% 
  left_join(total_over65_ca, by = "council_area") %>%  #joining to add 65+ populatino for CA
  left_join(filtered_heart_data, by = join_by(hbt == hbr)) %>%  #joining to add mortality rate
  filter(over_65_total_death != 0) %>% #Removed Council Area with 0 CVD Death Reports
  group_by(council_area) %>% 
  summarise(
    paid_quantity = sum(paid_quantity, na.rm = TRUE),
    over65_CA = first(over65_CA), #only picks the first value instead of summing because each row is already a sum
    over65_total_death = first(over_65_total_death, na_rm = TRUE)  
  ) 
  
```

##

```{r}
#making table
joined_data_final %>% 
  mutate(prescriptions_per_death = round(paid_quantity / over65_total_death, 1)) %>%
  select(
    council_area,
    over65_CA,
    paid_quantity,
    over65_total_death,
    prescriptions_per_death
  ) %>%
  arrange(desc(prescriptions_per_death)) %>%
  gt() %>%
  tab_header(
    title = "Prescriptions per Cardiovascular Death by Council Area"
  ) %>%
  fmt_number(columns = c(paid_quantity, over65_total_death), decimals = 0) %>%
  fmt_number(columns = prescriptions_per_death, decimals = 1) %>%
  cols_label(
    council_area = "Council Area",
    over65_CA = "Elderly Population",
    paid_quantity = "Total Prescriptions",
    over65_total_death = "Cardiovascular Deaths",
    prescriptions_per_death = "Prescriptions per Death"
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()
  ) %>%
  tab_source_note(
    source_note = "Data source: Prescription and mortality datasets."
  )


#scatter plot
ggplot(joined_data_final, aes(x = over65_CA, y = over65_total_death, color = paid_quantity)) +
  geom_point(alpha = 1, size = 4.5) +  # Scatter plot with size and color encoding
  geom_smooth(method = "lm", se = FALSE, color = "black", linetype = "dashed", alpha = 0.3, show.legend = FALSE) +  # Regression line
  scale_color_gradient(low = "lightblue", high = "red") +  # Gradient for color
  labs(
    title = "Relationship Between Older Population, Deaths, and Prescriptions",
    x = "Population Aged 65+",
    y = "Cardiovascular Deaths",
    size = "Prescriptions",
    color = "Prescriptions"
  ) +
  theme_minimal()




#Kable
library(knitr)
library(kableExtra)
```


#include stuff about at the end analysis about how CVD occurs more often in lower income more deprived areas and link it to SIMD data. just mention with references. and compare to see if trend makes sense or not to see if more prescription occurred in areas with higher SIMD 

#I've made coucnil are that are under same healthbaord into one row, treating them as one region for the analysis. Thus
```{r}
SIMD <- read_csv(here("/Users/Studnet Data/Year 4/data_science/B138584/data/SIMD.csv")) %>%
  clean_names()

#Filtering out SIMD and linking to CA
SIMD_Filtered <- SIMD %>% 
  left_join(filtered_hb_name, by = join_by(hb == hbt)) %>%
  select(hb_name, simd2020v2ca_quintile) %>%
  group_by(hb_name) %>% 
  summarise(mean_simd_rank = mean(simd2020v2ca_quintile, na.rm = TRUE))

SiMD_CA_relation <- SIMD_Filtered %>%   
  left_join(filtered_ca_hb, by = join_by(hb_name)) 

joined_data_final_CA <- joined_data_final %>% 
  left_join(SiMD_CA_relation, by = join_by(council_area)) 


```



## Correlation Analysis

Pearson analysis was used because it is good tu se for continuous variables [(Sereno, 2021)](https://www.analyticsvidhya.com/blog/2021/03/comparison-of-pearson-and-spearman-correlation-coefficients/). Correlation tests to see relatinoship.

```{r}
# Select numeric variables
#Correlation test: Older population vs. Prescriptions
cor_test_older <- cor.test(joined_data_final_CA$over65_CA, joined_data_final_CA$paid_quantity, method = "pearson")
cor_test_older

# Correlation test: Deprivation vs. Prescriptions
cor_test_deprivation <- cor.test(joined_data_final_CA$mean_simd_rank, joined_data_final_CA$paid_quantity, method = "pearson")

# Print the result
print(cor_test_deprivation)

# Correlation test: Deprivation vs. Cardiovascular Deaths
cor_test_cvd <- cor.test(joined_data_final_CA$mean_simd_rank, joined_data_final_CA$over65_total_death, method = "pearson")

# Print the result
print(cor_test_cvd)
```

```{r pressure, echo=FALSE}



```

Strong positive correlation between older population and antihypertensive prescription (r =0.98, p = 3.49e-11) and 
deprivation and prescription was moderate positive correlation suggesting less deprived areas might be associated with higher antihypertensive medication. However correlation was not statitically significant. (r=0.49, p = 0.07), 

The deprivation and cvd death showed no linear correlation (r = 0.002, p = 0.99) signifiyingThe correlation was statistically significant (p = 0.034). Results were counter intuitive with common belief because deprived areas are generally associated with poorer health. could be due to difference in acess to health care reporting.

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

## Conclusion


## References

British Heart Foundation (2018). The CVD Challenge in Scotland. [online] British Heart Foundation. Available at: https://www.bhf.org.uk/for-professionals/healthcare-professionals/data-and-statistics/the-cvd-challenge/the-cvd-challenge-in-scotland.

Fuchs, F.D. and Whelton, P.K. (2020). High Blood Pressure and Cardiovascular Disease. Hypertension, [online] 75(2), pp.285–292. doi:https://doi.org/10.1161/HYPERTENSIONAHA.119.14240.

Sereno (2021). Pearson vs Spearman Correlation | Comparison b/w Spearman & Pearson. [online] Analytics Vidhya. Available at: https://www.analyticsvidhya.com/blog/2021/03/comparison-of-pearson-and-spearman-correlation-coefficients/.
