---
title: Exploring the Relationship Between Deprivation, Cardiovascular Health, and Antihypertensive Prescriptions in Scotland
author: "Brian Kim"
date: "2024-11-01"
output:
  html_document: default
  pdf_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warnings=FALSE)
```

## Introduction

Cardiovascular disesase (CVD) refers to group of conditions affecting the heart and blood vessels. CVD is the leading cause of death both globally and in Scotland [(British Heart Foundation, 2018)](https://www.bhf.org.uk/for-professionals/healthcare-professionals/data-and-statistics/the-cvd-challenge/the-cvd-challenge-in-scotland), emphasizing the need to better understand their risk factors and treatment trends. The causes of CVD are multifactorial, with various risk factors contributing to its development. Among these, hypertension (high blood pressure) is commonly recognized as one of the strongest and most prevalent risk factor for CVD, with strong evidence supporting its causal relationship [(Fuchs and Whelton, 2020)](https://pubmed.ncbi.nlm.nih.gov/31865786/).

To address this growing risk, this project aimed to explore whether there is a trend in antihypertensvie medication prescribing acrouss council ares in Scotland. Specifically, the study aimed to examine the relationship between prescribing patterns and key demogrpahic factors that influence this such as age and deprivation levels. Data was analyzed on the level of council area  in Scotland. Speficially my project focused on examining whehter trend exist in anitherpyensive medication prescring areas with higher proportion of adults or areas with higher "deprivation score" according to the 2020 Scottish Index of Multiple Deprivation (SIMD), were associated with increasing prescribing of antihypertensvie medications.

For this report, "elderly" population refers to individuals aged 65 and older in alignment with common health guidelines. All datasets  used in this project and their respective data dictionaries were sourced from Public Health Scotland Open Data, which can be accessed here:
https://www.opendata.nhs.scot/

The scope of this report was limited to 2022 mainly because the heart diseease mortality dataset the most recent data was 2022 jan 1 to dec 31. Also because the GP demographic dataset most recent in 2022 was october, so i've chose to analyze the octoboer 2022 prescription dataset.


```{r Loading Libraries}
#Loading required libraries
library(tidyverse)
library(janitor)
library(gt)
library(here)
```

## Prescription Dataset
Started by loading the 2022 oct prescription data. Then also filter out for antihypertensive drugs. then also connect HB and join by HB and connect the council area (this file also has council name). So going to analyze by if there is differences in perscription of antihypertensives and the outcome depending on the council area by joining with heart outcome.

First filtering for drug, there is too many different types of antihypertensive to cover everything. Thus, we're specifically going to look at brand name and drug name for Calcium channel blockers. Calcium channel blockers can reduce blood pressure by dilating the arteries and, in some cases, reducing the force of the heart's contractions. becausedata set seem to have both brand and drug name.

```{r Prescription-dataset}

#Loading 2022 October Prescription Dataset
prescriptions_data <- read_csv("/Users/Studnet Data/Year 4/data_science/B138584/data/oct2022per.csv") %>% 
  clean_names()

#Filtering for calcium channel blockers 
calcium_channel_blockers <- c("Norvasc", "Amlodipine", "Diltiazem", "Cardizem", "Tiazac", "Plendil", "Felodipine", "DynaCirc", "Isradipine", "Cardene", "Nicardipine", "Sular", "Nisoldipine",  "Verelan", "Covera HS", "Isoptin SR", "Verapamil", "Procardia XL", "Adalat CC", "Nifedipine") %>% 
  toupper() #to make all letters uppercase

paste(calcium_channel_blockers, collapse = "|")

filtered_prescriptions <- prescriptions_data %>% 
  filter(str_detect(bnf_item_description, paste(calcium_channel_blockers, collapse = "|"))) %>% 
  filter(hbt != "SB0806") %>% #SB0806 indicate medication prescribed by Ambulance so filtered out cuz not related to CA
  select(gp_practice, hbt, bnf_item_description, paid_quantity) #filtering only the columns we're interested in

```

GP demographic data was then loaded and dealt with. As mentioned above to filter out the elder demographic filtered for people above 65. This was done by summing up population over 65 years old per GP (based on gp code) and then joining by gp code to the prescription dataset.

```{r GP-demographic}
gp_demographic_data <- read_csv("/Users/Studnet Data/Year 4/data_science/B138584/data/GPDemographic2022oct.csv") %>% 
  clean_names()

#filtering for age 65+ in GP demographic data then joining to perscription

filtered_gp <- gp_demographic_data %>% 
  mutate(over_65 = ages65to74 + ages75to84 + ages85plus) %>%   
  select(practice_code, hb, hscp, over_65) %>%  
  group_by(practice_code) %>% 
  summarise(over_65_total = sum(over_65, na.rm = TRUE)) 

#Joining GP_demographic data to prescription data
prescriptions_age <- filtered_prescriptions %>% 
  left_join(filtered_gp, by = join_by(gp_practice == practice_code)) 
```

Then healthboard names were joined by 
```{r}
#loading healthboard name data
Healthboards_name <- read_csv(here("/Users/Studnet Data/Year 4/data_science/week_7_thurs/Healthboard.csv")) %>%
  clean_names()
#adding HB name to prescription set with age
New_HB_name <- Healthboards_name %>% 
  rename(hbt = hb) %>% 
  select(hbt, hb_name)

joined_data <- prescriptions_age %>% 
  left_join(New_HB_name, join_by(hbt))
```

Then Council Area (CA) was joined. First loaded a dataset that
```{r}
CA_HB <- read_csv("/Users/Studnet Data/Year 4/data_science/B138584/data/CA:HB_CODES.csv") %>% 
  clean_names()
#joining Council area by healthboard code

CA_HB_2 <- CA_HB %>% 
  select(hb_name, ca_name, ca) %>% 
  group_by(hb_name) %>% 
  summarize(council_area = paste(unique(ca_name), collapse = ", "))

prescriptions_age_ca <- joined_data %>% 
  left_join(CA_HB_2, by = join_by(hb_name))
```

Lastly mortality rate from CVD was added
```{r}
heart_mortality <- read_csv("/Users/Studnet Data/Year 4/data_science/B138584/data/HeartDiseaseMortality.csv") %>% 
  clean_names()
#joining heart disease outcome by hb code

Heart2 <- heart_mortality %>% 
  select(year, hbr, number_of_deaths, age_group) %>% 
  filter(grepl('75plus years|65-74 years', age_group)) %>% 
  filter(year == 2022) %>% 
  group_by(hbr) %>% 
  summarise(over_65_total_death = sum(number_of_deaths, na.rm = TRUE))
  #filter(over_65_total_death > 0)
```


```{r}
#creating a column that has number of populatino for council area
over65_summary <- prescriptions_age_ca %>% 
  select(council_area, gp_practice, over_65_total) %>% 
  distinct() %>%  
  group_by(council_area) %>% 
  summarise(over65_CA = sum(over_65_total, na.rm = TRUE))

#prescriptions_age_ca_2 <- prescriptions_age_ca %>% 
 # left_join(over65_summary, by = "council_area")

#fii
joined_data_final <- prescriptions_age_ca %>% 
  left_join(over65_summary, by = "council_area") %>%  
  left_join(Heart2, by = join_by(hbt == hbr)) %>% 
  group_by(council_area) %>% 
  summarise(
    paid_quantity = sum(paid_quantity, na.rm = TRUE),
    over65_CA = first(over65_CA),
    over65_total_death = first(over_65_total_death, na_rm = TRUE)
  )


#making table

joined_data_final %>% 
  mutate(prescriptions_per_death = round(paid_quantity / over65_total_death, 1)) %>%
  select(
    council_area,
    over65_CA,
    paid_quantity,
    over65_total_death,
    prescriptions_per_death
  ) %>%
  arrange(desc(prescriptions_per_death)) %>%
  gt() %>%
  tab_header(
    title = "Prescriptions per Cardiovascular Death by Council Area"
  ) %>%
  fmt_number(columns = c(paid_quantity, over65_total_death), decimals = 0) %>%
  fmt_number(columns = prescriptions_per_death, decimals = 1) %>%
  cols_label(
    council_area = "Council Area",
    over65_CA = "Elderly Population",
    paid_quantity = "Total Prescriptions",
    over65_total_death = "Cardiovascular Deaths",
    prescriptions_per_death = "Prescriptions per Death"
  ) %>%
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_column_labels()
  ) %>%
  tab_source_note(
    source_note = "Data source: Prescription and mortality datasets."
  )


#scatter plot
ggplot(joined_data_final, aes(x = over65_CA, y = paid_quantity)) +
  geom_point(color = "blue", size = 3) +
  geom_smooth(method = "lm", se = FALSE, color = "red") +
  labs(title = "Relationship Between Over-65 Population and Prescriptions",
       x = "Over-65 Population",
       y = "Total Prescriptions") +
  theme_minimal()


ggplot(joined_data_final, aes(x = over65_CA, y = over65_total_death, size = paid_quantity)) +
  geom_point(alpha = 0.6, color = "purple") +
  labs(title = "Relationship Between Older Population, Deaths, and Prescriptions",
       x = "Population Aged 65+",
       y = "Cardiovascular Deaths",
       size = "Prescriptions") +
  theme_minimal()


#scatter different by color


ggplot(joined_data_final, aes(x = over65_CA, y = over65_total_death, size = paid_quantity, color = council_area)) +
  geom_point(alpha = 0.6) +
  labs(
    title = "Relationship Between Older Population, Deaths, and Prescriptions",
    x = "Population Aged 65+",
    y = "Cardiovascular Deaths",
    size = "Prescriptions",
    color = "Council Area"
  ) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    legend.title = element_text(face = "bold"),
    legend.text = element_text(size = 8)
  )


#Kable
library(knitr)
library(kableExtra)





```


#include stuff about at the end analysis about how CVD occurs more often in lower income more deprived areas and link it to SIMD data. just mention with references. and compare to see if trend makes sense or not to see if more prescription occurred in areas with higher SIMD 

#I've made coucnil are that are under same healthbaord into one row, treating them as one region for the analysis. Thus
```{r}
SIMD <- read_csv(here("/Users/Studnet Data/Year 4/data_science/B138584/data/SIMD.csv")) %>%
  clean_names()

#Filtering out SIMD and linking to CA
SIMD_Filtered <- SIMD %>% 
  left_join(New_HB_name, by = join_by(hb == hbt)) %>%
  select(hb_name, simd2020v2ca_quintile) %>%
  group_by(hb_name) %>% 
  summarise(mean_simd_rank = mean(simd2020v2ca_quintile, na.rm = TRUE))

SiMD_CA_relation <- SIMD_Filtered %>%   
  left_join(CA_HB_2, by = join_by(hb_name)) 

Joined_FINALL <- joined_data_final %>% 
  left_join(SiMD_CA_relation, by = join_by(council_area)) 


```



## Correlation Analysis

Pearson analysis was used because it is good tu se for continuous variables [(Sereno, 2021)](https://www.analyticsvidhya.com/blog/2021/03/comparison-of-pearson-and-spearman-correlation-coefficients/). Correlation tests to see relatinoship.

```{r}
# Select numeric variables
#Correlation test: Older population vs. Prescriptions
cor_test_older <- cor.test(Joined_FINALL$over65_CA, joined_data_final$paid_quantity, method = "pearson")
cor_test_older

# Correlation test: Deprivation vs. Prescriptions
cor_test_deprivation <- cor.test(Joined_FINALL$mean_simd_rank, joined_data_final$paid_quantity, method = "pearson")

# Print the result
print(cor_test_deprivation)

# Correlation test: Deprivation vs. Cardiovascular Deaths
cor_test_cvd <- cor.test(Joined_FINALL$mean_simd_rank, joined_data_final$over65_total_death, method = "pearson")

# Print the result
print(cor_test_cvd)
```

```{r pressure, echo=FALSE}



```

Strong positive correlation between older population and antihypertensive prescription (r =0.98, p = 3.49e-11) and deprivation and prescription was moderate positive correlation suggesting less deprived areas might be associated with higher antihypertensive medication. However correlation was not statitically significant. (r=0.49, p = 0.07), 

The results showed a moderate positive correlation (r = 0.567), indicating that less deprived areas (higher SIMD rank) are associated with higher cardiovascular death rates. The correlation was statistically significant (p = 0.034). Results were counter intuitive with common belief because deprived areas are generally associated with poorer health. could be due to difference in acess to health care reporting.

Note that the `echo = FALSE` parameter was added to the code chunk to prevent printing of the R code that generated the plot.

## References

British Heart Foundation (2018). The CVD Challenge in Scotland. [online] British Heart Foundation. Available at: https://www.bhf.org.uk/for-professionals/healthcare-professionals/data-and-statistics/the-cvd-challenge/the-cvd-challenge-in-scotland.

Fuchs, F.D. and Whelton, P.K. (2020). High Blood Pressure and Cardiovascular Disease. Hypertension, [online] 75(2), pp.285–292. doi:https://doi.org/10.1161/HYPERTENSIONAHA.119.14240.

Sereno (2021). Pearson vs Spearman Correlation | Comparison b/w Spearman & Pearson. [online] Analytics Vidhya. Available at: https://www.analyticsvidhya.com/blog/2021/03/comparison-of-pearson-and-spearman-correlation-coefficients/.
